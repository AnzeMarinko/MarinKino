{% extends "base.html" %}

{% block title %}{{ pagetitle }}{% endblock %}

{% block content %}
<script src="https://cdn.plot.ly/plotly-3.3.1.min.js"></script>
<h1>Nadzorna plošča</h1>

<!-- View As Controls -->
<div class="alert alert-info d-flex align-items-center justify-content-between mb-3">
  <div>
    <strong>Prikazi stran kot:</strong>
    {% if view_as == "anonymous" %}
      <span class="badge bg-warning">Neprijavljen</span>
    {% elif view_as == "user" %}
      <span class="badge bg-warning">Navaden uporabnik</span>
    {% else %}
      <span class="badge bg-success">Administrator</span>
    {% endif %}
  </div>
  <div class="btn-group btn-group-sm">
    <a href="/set-view-as/anonymous" class="btn btn-warning {% if view_as == 'anonymous' %}active{% endif %}">Neprijavljen</a>
    <a href="/set-view-as/user" class="btn btn-warning {% if view_as == 'user' %}active{% endif %}">Navaden uporabnik</a>
    <a href="/clear-view-as" class="btn btn-success {% if not view_as %}active{% endif %}">Administrator</a>
  </div>
</div>

<a href="/send_admin_emails" class="btn btn-sm btn-outline-info">Pošiljanje mailov uporabnikom</a>

<h2>Statistika ogledov filmov</h2>
<div class="table-responsive">
<table id="views-table" class="table table-striped table-hover table-bordered">
        <thead class="thead-light">
                <tr>
                        <th>Uporabnik</th>
                        {% for column in users_stats_columns %}
                        <th>{{ column }}</th>
                        {% endfor %}
                </tr>
        </thead>
        <tbody>
                {% for user, data in users_stats.items() %}
                <tr>
                        <td>{{ user }}</td>
                        {% for column in users_stats_columns %}
                        <td>{{ data[column] }}</td>
                        {% endfor %}
                </tr>
                {% endfor %}
        </tbody>
</table>
</div>

<b>{{ users_count }} uporabnikov z e-mail naslovi:</b> {{ emails }}

<style>
#views-table th.sortable { cursor: pointer; user-select: none; }
.sort-indicator { margin-left: 6px; font-size: 0.8em; opacity: 0.85; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function(){
    const table = document.getElementById('views-table');
    if(!table) return;
    const tbody = table.tBodies[0];
    const headers = table.tHead.querySelectorAll('th');
    headers.forEach(function(th, index){
        th.classList.add('sortable');
        const span = document.createElement('span');
        span.className = 'sort-indicator';
        th.appendChild(span);
        th.addEventListener('click', function(){
            const currentOrder = th.dataset.order === 'asc' ? 'desc' : 'asc';
            headers.forEach(h => { delete h.dataset.order; const s = h.querySelector('.sort-indicator'); if(s) s.textContent = ''; });
            th.dataset.order = currentOrder;
            span.textContent = currentOrder === 'asc' ? '▲' : '▼';
            const rows = Array.from(tbody.querySelectorAll('tr'));
            rows.sort(function(a,b){
                const aText = (a.cells[index] && a.cells[index].textContent.trim()) || '';
                const bText = (b.cells[index] && b.cells[index].textContent.trim()) || '';
                const aNum = (aText[0] === '-' ? -1 : 1) * parseFloat(aText.replace(/[^0-9.]/g, ''));
                const bNum = (bText[0] === '-' ? -1 : 1) * parseFloat(bText.replace(/[^0-9.]/g, ''));

                if(!isNaN(aNum) && !isNaN(bNum)){
                    return currentOrder === 'asc' ? aNum - bNum : bNum - aNum;
                }
                return currentOrder === 'asc' ? aText.localeCompare(bText, undefined, {numeric:true, sensitivity:'base'}) : bText.localeCompare(aText, undefined, {numeric:true, sensitivity:'base'});
            });
            rows.forEach(r => tbody.appendChild(r));
        });
    });
});
</script>

<h2>Ogled statistike dostopa</h2>

<div class="card">
    <div class="card-header">Mesečna statistika dostopa</div>
    <div class="card-body p-2">
        <div class="table-responsive">
        <table class="table table-striped table-hover table-bordered mb-0">
            <thead class="thead-light">
                <tr>
                    <th>Mesec</th>
                    {% for column in monthly_columns %}
                    <th>{{ column }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for month, data in access_stats_monthly.items() %}
                <tr>
                    <td>{{ month }}</td>
                    {% for column in monthly_columns %}
                    <td>{{ data[column] }}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">Filtriraj po statusu</div>
            <div class="card-body">
                <div class="form-group">
                    <label for="status-select">Izberite status odgovora:</label>
                    <div>
                        {% for status in access_stats_users.keys() %}
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="status" id="status-{{ loop.index }}" value="{{ status }}" onchange="plotStatus('{{ status }}')" {% if loop.first %}checked{% endif %}>
                                <label class="form-check-label" for="status-{{ loop.index }}">{{ status }}</label>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <div class="card mb-3">
            <div class="card-header">Dostop uporabnikov</div>
            <div class="card-body">
                <div id="access-user-graph" style="min-height:320px; width:100%;"></div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">Dostop do poti skozi čas</div>
            <div class="card-body">
                <div id="access-graph" style="min-height:320px; width:100%;"></div>
            </div>
        </div>
    </div>
</div>

<script>
    var accessDataUsers = {{ access_stats_users | tojson | safe }};  
    var statuses = Object.keys(accessDataUsers);
    var currentStatus = statuses[0] || null;

    function getLegendLayout(containerId){
        var el = document.getElementById(containerId);
        var width = el ? el.clientWidth : window.innerWidth;
        if(width < 576){
            return { orientation: 'h', x: 0, y: 1.12, xanchor: 'left' };
        }
        return { orientation: 'v', x: 1.02, y: 1, xanchor: 'left' };
    }

    function plotStatus(selectedStatusToPlot) {
        currentStatus = selectedStatusToPlot;
        var dates = Object.keys(accessDataUsers[selectedStatusToPlot]);
        var userNames = {{ users | tojson | safe }}; 
        var data = [];
        userNames.forEach(function(user) {
                var yValues = dates.map(function(date) {
                    return accessDataUsers[selectedStatusToPlot][date][user]?.["count"] || 0;
                });
                var meta = dates.map(function(date) {
                    return accessDataUsers[selectedStatusToPlot][date][user]?.["routes"] || "";
                });
                if (yValues.every(v => v === 0)) return;
            data.push({
                x: dates,
                y: yValues,
                text: meta.map(r => 'Poti: ' + r.replace(/\n/g, '<br>')),
                hovertemplate: '%{x}<br>Dostopi: %{y}<br>%{text}<extra></extra>',
                mode: 'lines+markers',
                name: user,
                showlegend: true
            });
        });
        var layout_users = {
            title: 'Dostop uporabnikov s statusom ' + selectedStatusToPlot + ' skozi čas',
            xaxis: { title: 'Datum' },
            yaxis: { title: 'Število dostopov' }
        };
        var legendLayout = getLegendLayout('access-user-graph');
        layout_users.legend = Object.assign({}, legendLayout, { traceorder: 'normal' });
        layout_users.margin = legendLayout.orientation === 'h' ? {t:90, b:40, l:40, r:20} : {t:60, b:40, l:40, r:120};
        Plotly.newPlot('access-user-graph', data, layout_users, {responsive: true});
    };
    // Prikaži začetni graf za prvi status
    plotStatus(statuses[0]);

    var accessData = {{ access_stats_routes | tojson | safe }};  
    var dates = Object.keys(accessData);
    var routeNames = Object.keys(accessData[dates[0]]);
    function renderRoutes(){
        var data_routes = [];
        routeNames.forEach(function(route) {
            var yValues = dates.map(function(date) {
                return accessData[date][route] || 0;
            });
            data_routes.push({
                x: dates,
                y: yValues,
                mode: 'lines+markers',
                name: route,
                showlegend: true
            });
        });
        var layout = {
            title: 'Dostop do poti skozi čas',
            xaxis: { title: 'Datum' },
            yaxis: { title: 'Število dostopov' }
        };
        var legendLayout = getLegendLayout('access-graph');
        layout.legend = Object.assign({}, legendLayout, { traceorder: 'normal' });
        layout.margin = legendLayout.orientation === 'h' ? {t:90, b:40, l:40, r:20} : {t:60, b:40, l:40, r:120};
        Plotly.newPlot('access-graph', data_routes, layout, {responsive: true});
    }
    renderRoutes();

    var resizeTimeout;
    window.addEventListener('resize', function(){
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(function(){
            if(currentStatus) plotStatus(currentStatus);
            renderRoutes();
        }, 200);
    });

</script>

<h2>Zadnji log file</h2>
<div class="card">
    <div class="card-header">Zadnji log file</div>
    <div class="card-body p-2">
        <pre class="mb-0 small text-muted" style="max-height:360px; overflow:auto; white-space:pre-wrap;">{{ system_log }}</pre>
    </div>
</div>

<h2>Upravljanje komentarjev na filmih</h2>
<div id="comments-container">
    <div class="text-center">
        <p>Priprava komentarjev...</p>
    </div>
</div>

<style>
.alert-item {
    border: 1px solid #ddd;
    padding: 15px;
    margin: 10px 0;
    border-radius: 8px;
    background-color: #f0f8ff;
}

.alert-icon {
    font-size: 1.5rem;
    margin-right: 10px;
}

.alert-actions {
    margin-top: 10px;
    display: flex;
    gap: 10px;
}

.alert-actions button {
    padding: 6px 12px;
    font-size: 0.9rem;
    cursor: pointer;
    border: none;
    border-radius: 4px;
}

.btn-edit-alert {
    background-color: #17a2b8;
    color: white;
}

.btn-delete-alert {
    background-color: #dc3545;
    color: white;
}

.alert-edit-form {
    background-color: white;
    padding: 15px;
    margin-top: 15px;
    border-radius: 8px;
    border: 2px solid #007bff;
}

.alert-form-group {
    margin: 10px 0;
}

.alert-form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
}

.alert-form-group input,
.alert-form-group textarea,
.alert-form-group select {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-family: Arial, sans-serif;
}

.add-alert-form {
    background-color: #e8f5e9;
    padding: 15px;
    margin: 15px 0;
    border-radius: 8px;
    border-left: 4px solid #4caf50;
}

.movie-alerts-list {
    background-color: white;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #ddd;
}

.comment-item {
    border: 1px solid #ddd;
    padding: 15px;
    margin: 10px 0;
    border-radius: 8px;
    background-color: #f9f9f9;
}

.comment-item.has-response {
    border-left: 4px solid #28a745;
}

.comment-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.comment-author {
    font-weight: bold;
    color: #333;
}

.comment-movie-title {
    font-size: 0.9rem;
    color: #666;
}

.comment-text {
    background-color: white;
    padding: 10px;
    margin: 10px 0;
    border-left: 3px solid #ffcc5c;
}

.admin-response-form {
    background-color: white;
    padding: 10px;
    margin-top: 10px;
    border-radius: 4px;
}

.admin-response-form textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-family: Arial, sans-serif;
}

.admin-response-form button {
    background-color: #28a745;
    color: white;
    margin-top: 10px;
}

.existing-response {
    background-color: #d4edda;
    padding: 10px;
    margin-top: 10px;
    border-left: 3px solid #28a745;
    border-radius: 4px;
}
</style>

<script>
function loadComments() {
    fetch('/movies/get-comments')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('comments-container');
            
            if (data.comments.length === 0) {
                container.innerHTML = '<p>Ni novih komentarjev.</p>';
                return;
            }
            
            let html = '';
            data.comments.forEach(comment => {
                const hasResponse = comment.admin_response ? true : false;
                html += `
                    <div class="comment-item ${hasResponse ? 'has-response' : ''}">
                        <div class="comment-header">
                            <div>
                                <div class="comment-author">${comment.author}</div>
                                <div class="comment-movie-title"><a href="/movies/play${comment.movie_folder}">
                                    ${comment.movie_title}</a></div>
                                <small class="text-muted">${comment.email} (${comment.date})</small>
                            </div>
                        </div>
                        <div class="comment-text">${comment.text}</div>
                        ${hasResponse ? `<div class="existing-response"><strong>Odgovor:</strong> ${comment.admin_response}</div>` : ''}
                        ${!hasResponse ? `
                            <div class="admin-response-form">
                                <textarea placeholder="Napišite odgovor na komentar..." data-movie="${comment.movie_folder}" data-index="${comment.comment_index}"></textarea>
                                <button onclick="submitAdminResponse(this)">Pošlji odgovor</button>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        })
        .catch(error => console.error('Error:', error));
}

function submitAdminResponse(button) {
    const textarea = button.previousElementSibling;
    const response = textarea.value.trim();
    const movieFolder = textarea.dataset.movie;
    const commentIndex = textarea.dataset.index;
    
    if (!response) {
        alert('Odgovor ne sme biti prazen');
        return;
    }
    
    const data = {
        movieFolder: movieFolder,
        commentIndex: commentIndex,
        response: response
    };
    
    fetch('/movies/admin-comment', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            "X-CSRFToken": "{{ csrf_token() }}"
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.status === 'success') {
            alert('Odgovor je bil poslan!');
            loadComments();
        } else {
            alert('Napaka: ' + result.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Napaka pri pošiljanju odgovora');
    });
}

// Učitaj komentarje ob nalaganju strani
document.addEventListener('DOMContentLoaded', loadComments);
</script>

{% endblock %}
