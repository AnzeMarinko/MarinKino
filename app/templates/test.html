<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Primerjava</title>

<style>
body {
  font-family: system-ui, sans-serif;
  margin: 20px;
}

table {
  width: 100%;
  border-collapse: collapse;
}

th {
  background: #eee;
  padding: 10px;
}

td {
  border: 1px solid #ccc;
  padding: 10px;
  vertical-align: top;
  cursor: pointer;
}

td.selected {
  background: #cde7ff;
  outline: 3px solid #3390ff;
}

img {
  max-width: 220px;
  display: block;
  margin-bottom: 10px;
}

.nav {
  margin-top: 20px;
  display: flex;
  justify-content: space-between;
}

button {
  padding: 10px 20px;
  font-size: 16px;
}
</style>
</head>

<body>

<h2 id="counter"></h2>

<div class="nav">
  <button onclick="prev()">‚Üê Nazaj</button>
  <button onclick="saveAndNext()">Shrani & Naprej ‚Üí</button>
</div>

<table>
<thead>
<tr>
  <th>Polje</th>
  <th>Staro</th>
  <th>Novo (TMDB)</th>
</tr>
</thead>

<tbody id="rows"></tbody>
</table>

<script>
const movies = {{ movies|tojson }};
let index = 0;

const fields = [
  ["title", "Naslov"],
  ["original_title", "Originalni Naslov"],
  ["year", "Letnica"],
  ["description", "Opis"],
  ["players", "Igralci"],
  ["genres", "Zvrsti"],
  ["cover", "Slika"]
];

let selected = {};

function render() {
  const m = movies[index];
  document.getElementById("counter").innerText =
    `Film ${m.old.folder} (${index+1} / ${movies.length})`;

  rows.innerHTML = "";
  selected = {};

  for (const [key, label] of fields) {
    const tr = document.createElement("tr");

    const tdLabel = document.createElement("td");
    tdLabel.innerText = label;
    tr.appendChild(tdLabel);

    const tdOld = document.createElement("td");
    const tdNew = document.createElement("td");

    if (key === "cover") {
      tdOld.innerHTML = `<img src="/movies/file${m.old.cover}">`;
      tdNew.innerHTML = `<img src="/movies/file${m.new.cover}">`;
    } else {
      tdOld.innerText = m.old[key] || "";
      tdNew.innerText = m.new[key] || "";
    }

    tdOld.onclick = () => choose(key, "old", tdOld, tdNew);
    tdNew.onclick = () => choose(key, "new", tdNew, tdOld);

    tr.appendChild(tdOld);
    tr.appendChild(tdNew);
    rows.appendChild(tr);

    // default: izberi stare
    choose(key, "old", tdOld, tdNew);
  }
}

function choose(field, value, on, off) {
  selected[field] = value;
  on.classList.add("selected");
  off.classList.remove("selected");
}

function saveAndNext() {
  fetch("/save_decision", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({
      index: index,
      fields: selected
    })
  });

  if (index < movies.length - 1) {
    index++;
    render();
  } else {
    alert("Konec üéâ");
  }
}

function prev() {
  if (index > 0) {
    index--;
    render();
  }
}

render();
</script>

</body>
</html>
