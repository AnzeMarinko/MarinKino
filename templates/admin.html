{% extends "base.html" %}

{% block title %}{{ pagetitle }}{% endblock %}

{% block content %}
<script src="https://cdn.plot.ly/plotly-3.3.1.min.js"></script>
<h1>Nadzorna plošča</h1>  

<h2>Statistika ogledov filmov</h2>
<div class="table-responsive">
<table id="views-table" class="table table-striped table-hover table-bordered">
        <thead class="thead-light">
                <tr>
                        <th>Uporabnik</th>
                        {% for column in users_stats_columns %}
                        <th>{{ column }}</th>
                        {% endfor %}
                </tr>
        </thead>
        <tbody>
                {% for user, data in users_stats.items() %}
                <tr>
                        <td>{{ user }}</td>
                        {% for column in users_stats_columns %}
                        <td>{{ data[column] }}</td>
                        {% endfor %}
                </tr>
                {% endfor %}
        </tbody>
</table>
</div>

<style>
#views-table th.sortable { cursor: pointer; user-select: none; }
.sort-indicator { margin-left: 6px; font-size: 0.8em; opacity: 0.85; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function(){
    const table = document.getElementById('views-table');
    if(!table) return;
    const tbody = table.tBodies[0];
    const headers = table.tHead.querySelectorAll('th');
    headers.forEach(function(th, index){
        th.classList.add('sortable');
        const span = document.createElement('span');
        span.className = 'sort-indicator';
        th.appendChild(span);
        th.addEventListener('click', function(){
            const currentOrder = th.dataset.order === 'asc' ? 'desc' : 'asc';
            headers.forEach(h => { delete h.dataset.order; const s = h.querySelector('.sort-indicator'); if(s) s.textContent = ''; });
            th.dataset.order = currentOrder;
            span.textContent = currentOrder === 'asc' ? '▲' : '▼';
            const rows = Array.from(tbody.querySelectorAll('tr'));
            rows.sort(function(a,b){
                const aText = (a.cells[index] && a.cells[index].textContent.trim()) || '';
                const bText = (b.cells[index] && b.cells[index].textContent.trim()) || '';
                const aNum = (aText[0] === '-' ? -1 : 1) * parseFloat(aText.replace(/[^0-9.]/g, ''));
                const bNum = (bText[0] === '-' ? -1 : 1) * parseFloat(bText.replace(/[^0-9.]/g, ''));

                if(!isNaN(aNum) && !isNaN(bNum)){
                    return currentOrder === 'asc' ? aNum - bNum : bNum - aNum;
                }
                return currentOrder === 'asc' ? aText.localeCompare(bText, undefined, {numeric:true, sensitivity:'base'}) : bText.localeCompare(aText, undefined, {numeric:true, sensitivity:'base'});
            });
            rows.forEach(r => tbody.appendChild(r));
        });
    });
});
</script>

<h2>Ogled statistike dostopa</h2>

<div class="card">
    <div class="card-header">Mesečna statistika dostopa</div>
    <div class="card-body p-2">
        <div class="table-responsive">
        <table class="table table-striped table-hover table-bordered mb-0">
            <thead class="thead-light">
                <tr>
                    <th>Mesec</th>
                    {% for column in monthly_columns %}
                    <th>{{ column }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for month, data in access_stats_monthly.items() %}
                <tr>
                    <td>{{ month }}</td>
                    {% for column in monthly_columns %}
                    <td>{{ data[column] }}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">Filtriraj po statusu</div>
            <div class="card-body">
                <div class="form-group">
                    <label for="status-select">Izberite status odgovora:</label>
                    <div>
                        {% for status in access_stats_users.keys() %}
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="status" id="status-{{ loop.index }}" value="{{ status }}" onchange="plotStatus('{{ status }}')" {% if loop.first %}checked{% endif %}>
                                <label class="form-check-label" for="status-{{ loop.index }}">{{ status }}</label>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <div class="card mb-3">
            <div class="card-header">Dostop uporabnikov</div>
            <div class="card-body">
                <div id="access-user-graph" style="min-height:320px; width:100%;"></div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">Dostop do poti skozi čas</div>
            <div class="card-body">
                <div id="access-graph" style="min-height:320px; width:100%;"></div>
            </div>
        </div>
    </div>
</div>

<script>
    var accessDataUsers = {{ access_stats_users | tojson | safe }};  
    var statuses = Object.keys(accessDataUsers);
    var currentStatus = statuses[0] || null;

    function getLegendLayout(containerId){
        var el = document.getElementById(containerId);
        var width = el ? el.clientWidth : window.innerWidth;
        if(width < 576){
            return { orientation: 'h', x: 0, y: 1.12, xanchor: 'left' };
        }
        return { orientation: 'v', x: 1.02, y: 1, xanchor: 'left' };
    }

    function plotStatus(selectedStatusToPlot) {
        currentStatus = selectedStatusToPlot;
        var dates = Object.keys(accessDataUsers[selectedStatusToPlot]);
        var userNames = Object.keys(accessDataUsers[selectedStatusToPlot][dates[0]]);
        var data = [];
        userNames.forEach(function(user) {
                var yValues = dates.map(function(date) {
                    return accessDataUsers[selectedStatusToPlot][date][user]?.["count"] || 0;
                });
                var meta = dates.map(function(date) {
                    return accessDataUsers[selectedStatusToPlot][date][user]?.["routes"] || "";
                });
            data.push({
                x: dates,
                y: yValues,
                text: meta.map(r => 'Poti: ' + r.replace(/\n/g, '<br>')),
                hovertemplate: '%{x}<br>Dostopi: %{y}<br>%{text}<extra></extra>',
                mode: 'lines+markers',
                name: user,
                showlegend: true
            });
        });
        var layout_users = {
            title: 'Dostop uporabnikov s statusom ' + selectedStatusToPlot + ' skozi čas',
            xaxis: { title: 'Datum' },
            yaxis: { title: 'Število dostopov' }
        };
        var legendLayout = getLegendLayout('access-user-graph');
        layout_users.legend = Object.assign({}, legendLayout, { traceorder: 'normal' });
        layout_users.margin = legendLayout.orientation === 'h' ? {t:90, b:40, l:40, r:20} : {t:60, b:40, l:40, r:120};
        Plotly.newPlot('access-user-graph', data, layout_users, {responsive: true});
    };
    // Prikaži začetni graf za prvi status
    plotStatus(statuses[0]);

    var accessData = {{ access_stats_routes | tojson | safe }};  
    var dates = Object.keys(accessData);
    var routeNames = Object.keys(accessData[dates[0]]);
    function renderRoutes(){
        var data_routes = [];
        routeNames.forEach(function(route) {
            var yValues = dates.map(function(date) {
                return accessData[date][route] || 0;
            });
            data_routes.push({
                x: dates,
                y: yValues,
                mode: 'lines+markers',
                name: route,
                showlegend: true
            });
        });
        var layout = {
            title: 'Dostop do poti skozi čas',
            xaxis: { title: 'Datum' },
            yaxis: { title: 'Število dostopov' }
        };
        var legendLayout = getLegendLayout('access-graph');
        layout.legend = Object.assign({}, legendLayout, { traceorder: 'normal' });
        layout.margin = legendLayout.orientation === 'h' ? {t:90, b:40, l:40, r:20} : {t:60, b:40, l:40, r:120};
        Plotly.newPlot('access-graph', data_routes, layout, {responsive: true});
    }
    renderRoutes();

    var resizeTimeout;
    window.addEventListener('resize', function(){
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(function(){
            if(currentStatus) plotStatus(currentStatus);
            renderRoutes();
        }, 200);
    });

</script>

<h2>Zadnji log file</h2>
<div class="card">
    <div class="card-header">Zadnji log file</div>
    <div class="card-body p-2">
        <pre class="mb-0 small text-muted" style="max-height:360px; overflow:auto; white-space:pre-wrap;">{{ system_log }}</pre>
    </div>
</div>

{% endblock %}
