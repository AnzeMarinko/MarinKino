<!DOCTYPE html>
<html lang="sl">
<head>
<meta charset="UTF-8">
<title>Zbirka glasbe</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
	<link rel="icon" href="/static/logo.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <style>
body {
    margin: 0;
    height: 100vh;
    display: flex;
    flex-direction: column;
}

/* Zgornja polovica: 50% */
#browser {
    flex: 1;
    display: flex;
    border-bottom: 2px solid #444;
    overflow: hidden;
}

/* Albumi levo */
#albums {
    width: 25%;
    overflow-y: auto;
    padding: 10px;
}

#albums h2 {
    margin-top: 0;
}

.album-item {
    padding: 8px;
    cursor: pointer;
    border-radius: 4px;
}
.album-item:hover, .album-item.active {
    color: white;
    background-color: #ca8402;;
}

/* Pesmi desno */
#tracks {
    flex: 1;
    background: #f8e0b2;
    overflow-y: auto;
    padding: 10px;
}

.track-item {
    padding: 8px;
    cursor: pointer;
    border-radius: 4px;
}
.track-item:hover, .track-item.active {
    background: white;
    color: black
}

/* Spodnja polovica: player */
#player {
    flex: 1;
    padding: 20px;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    background: white;
    box-sizing: border-box;
    align-items: center;
}

#nowPlaying {
    font-size: 24px;
    margin-bottom: 10px;
    text-align: center;
}

#controls {
    margin-top: 20px;
}

button {
    padding: 8px 12px;
    margin-right: 5px;
    font-size: 20px;
    background: #5a5a5a;
    border: none;
    color: white;
    cursor: pointer;
    border-radius: 8px;
}
button:hover {
    background: #555;
}

#seekBar {
    width: 100%;
    margin-top: 10px;
}

#timeDisplay {
    margin-top: 5px;
    font-size: 14px;
    text-align: right;
}

.btn-player {
    font-size: 1.5rem;
    border-radius: 50%;
    width: 52px;
    height: 52px;
    padding: 0;
}
.btn-play {
    background: #87b7ff;
    color: black;
}
.btn-play.active:hover,
.btn-play:hover {
    background: #438eff;
    color: white;
}
.btn-play.active {
    background: #0a6bfd;
    color: white;
}
.btn-rnd {
    background: #c7ffb9;
    color: black;
}
.btn-rnd.active {
    background: #1e9700;
    color: white;
}
.btn-rnd.active:hover,
.btn-rnd:hover {
    background: #96ff7c;
    color: white;
}

    </style>
</head>
<body class="bg-light text-dark">


<nav class="navbar navbar-expand-lg navbar-light bg-white shadow">
  <div class="container-fluid">

    <!-- LOGO + NASLOV -->
    <a class="navbar-brand d-flex align-items-center gap-2" href="/">
      <img src="/static/logo.png" height="36">
      MarinKino
    </a>

    <!-- HAMBURGER -->
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar">
      <span class="navbar-toggler-icon"></span>
    </button>

    <!-- MENI -->
    <div class="collapse navbar-collapse" id="mainNavbar">

      <!-- LEVI MENI -->
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="/meme">Šale & navdihi</a></li>
        <li class="nav-item"><a class="nav-link" href="/music"><strong>Glasba</strong></a></li>
        <li class="nav-item"><a class="nav-link" href="https://anzemarinko.github.io/pod_krinko">Pod krinko</a></li>
      </ul>

      <!-- DESNI DEL: UPORABNIK -->
      <div class="d-flex flex-column flex-lg-row align-items-lg-center gap-2">
        <span class="text-secondary">
          Bog daj <span id="greeting"></span>, <strong>{{ current_user.id }}</strong>
        </span>

        <a href="/logout" class="btn btn-sm btn-outline-info">Odjava</a>
      </div>

    </div>
  </div>
</nav>


<div id="browser">
    <div id="albums">
        <h2>Albumi</h2>
        <div id="albumList"></div>
    </div>
    <div id="tracks">
        <h2>Pesmi</h2>
        <div id="trackList"></div>
    </div>
</div>

<!-- PLAYER -->
<div id="player" class="p-3 shadow-sm">

  <div id="nowPlaying" class="text-center mb-2 text-primary">
    Ni izbrane pesmi
  </div>

  <audio id="audio" preload="auto"></audio>

  <div class="d-flex justify-content-center gap-3 my-2">
    <button class="btn btn-outline-secondary control-btn" onclick="prev()">
      <i class="bi bi-skip-backward-fill"></i>
    </button>

    <button id="playBtn" class="btn-player btn-play" onclick="togglePlay()">
      <i class="bi bi-play-fill"></i>
    </button>

    <button class="btn btn-outline-secondary control-btn" onclick="next()">
      <i class="bi bi-skip-forward-fill"></i>
    </button>

    <button id="shuffleBtn" class="btn-player btn-rnd" onclick="toggleRandom()">
      <i class="bi bi-shuffle"></i>
    </button>

{% if current_user.is_admin %}
<button id="delete-btn" class="btn btn-danger shadow" onclick="izbrisiPesem()">
  <i class="bi bi-trash"></i>
</button>
{% endif %}
  </div>

  <input type="range" id="seekBar" class="form-range">

  <div id="timeDisplay" class="text-end text-muted small">
    0:00 / 0:00
  </div>
</div>

</body>

<script>
const albums = {{ albums|tojson }};

const albumListEl = document.getElementById("albumList");
const trackListEl = document.getElementById("trackList");
const audio = document.getElementById("audio");
const nowPlaying = document.getElementById("nowPlaying");
const progress = document.getElementById("seekBar");
const timeDisplay = document.getElementById("timeDisplay");

let currentAlbum = localStorage.getItem("album") || "Vse";
let currentTrack = localStorage.getItem("track") || null;
let currentTime = parseFloat(localStorage.getItem("time") || 0);
let currentSongs = [];
let currentIndex = -1;

// Render albumi
function renderAlbums() {
    albumListEl.innerHTML = "";
    Object.keys(albums).forEach(a => {
        const div = document.createElement("div");
        div.textContent = a;
        div.className = "album-item" + (a===currentAlbum?" active":"");
        div.onclick = () => loadAlbum(a);
        albumListEl.appendChild(div);
    });
}

// Load album
function loadAlbum(name) {
    currentAlbum = name;
    localStorage.setItem("album", name);
    currentSongs = albums[name];
    renderAlbums();

    trackListEl.innerHTML = "";
    currentSongs.forEach((s,i)=>{
        const div = document.createElement("div");
        div.textContent = s.split("/").join(" : ");
        div.className = "track-item" + (s===currentTrack?" active":"");
        div.onclick = ()=>playTrack(i);
        trackListEl.appendChild(div);
    });
    scrollToActiveTrack();
}

// Play track
function playTrack(i) {
    currentIndex = i;
    currentTrack = currentSongs[i];
    localStorage.setItem("track", currentTrack);
    nowPlaying.textContent = currentTrack.split("/").pop();
    audio.src = "/music/" + currentTrack;
    audio.currentTime = 0;
    audio.play().catch(()=>{});
    highlightTrack();
    scrollToActiveTrack();
}

function highlightTrack() {
    document.querySelectorAll(".track-item").forEach((t, idx)=>{
        t.classList.toggle("active", idx===currentIndex);
    });
}

function scrollToActiveTrack() {
    const active = document.querySelector(".track-item.active");
    if(active) active.scrollIntoView({behavior:"smooth", block:"center"});
}

// Controls
function togglePlay() { 
    if(audio.paused) {
        audio.play();
        updatePlayBtn("true")}
    else {
        audio.pause(); updatePlayBtn("false"); }}
function next() {
    if(randomMode) playTrack(Math.floor(Math.random()*currentSongs.length));
    else if(currentIndex<currentSongs.length-1) playTrack(currentIndex+1);
}
function prev() { if(currentIndex>0) playTrack(currentIndex-1); }

const shuffleBtn = document.getElementById("shuffleBtn");
let randomMode = JSON.parse(localStorage.getItem("random") || "false");

const playBtn = document.getElementById("playBtn");

// Posodobimo gumb ob zagonu
updateShuffleBtn();
updatePlayBtn("false");

// Toggle random
function toggleRandom() {
    randomMode = !randomMode;
    localStorage.setItem("random", randomMode);
    updateShuffleBtn();
}

function updateShuffleBtn() {
    if(randomMode) shuffleBtn.classList.add("active");
    else shuffleBtn.classList.remove("active");
}

function updatePlayBtn(playMode) {
    if(playMode == "true") playBtn.classList.add("active");
    else playBtn.classList.remove("active");
}

// EQ animacija glede na predvajanje
const eqBars = document.querySelectorAll(".eq-bar");

function updateEQ() {
    eqBars.forEach((bar)=>{
        if(!audio.paused && !audio.ended){
            const h = Math.random()*20 + 5; // višina 5-25px
            bar.style.height = h+"px";
        } else {
            bar.style.height = "5px"; // mirujoče
        }
    });
}

// Kličemo vsakih 100ms
setInterval(updateEQ, 100);

// Audio update
audio.ontimeupdate = ()=>{
    if(audio.duration){
        progress.value = audio.currentTime;
        localStorage.setItem("time", audio.currentTime);
        timeDisplay.textContent = formatTime(audio.currentTime)+" / "+formatTime(audio.duration);
    }
};
audio.onloadedmetadata = ()=>{
    progress.max = audio.duration;
    if(currentTime && currentTrack===audio.src.replace("/music/","")) audio.currentTime=currentTime;
};
progress.oninput = ()=>{ audio.currentTime = progress.value; }
audio.onended = ()=>next();

function formatTime(s){
    s=Math.floor(s);
    const m=Math.floor(s/60);
    const sec=s%60;
    return m+":"+sec.toString().padStart(2,"0");
}

function izbrisiPesem() {
    const token = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    if (confirm("Res želiš izbrisati to pesem?")) {
        fetch(`/music/delete/` + currentTrack, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': token
            }
        })
        .then(response => {
            if (response.ok) {
                next();
            } else {
                alert("Napaka pri brisanju pesmi!");
            }
        });
    }
}

// Initialize
renderAlbums();
if(currentTrack && currentSongs.length>0) playTrack(currentIndex||0);
else loadAlbum(currentAlbum);
</script>

</html>
