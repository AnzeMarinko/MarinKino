<!DOCTYPE html>
<html lang="sl">
<head>
<meta charset="UTF-8">
<title>Zbirka glasbe</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
	<link rel="icon" href="/static/logo.png">
<style>
body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #1e1e1e;
    color: white;
    height: 100vh;
    display: flex;
    flex-direction: column;
}

/* Zgornja polovica: 50% */
#browser {
    flex: 1;
    display: flex;
    border-bottom: 2px solid #444;
    overflow: hidden;
}

/* Albumi levo */
#albums {
    width: 25%;
    background: #2b2b2b;
    overflow-y: auto;
    padding: 10px;
}

#albums h2 {
    margin-top: 0;
}

.album-item {
    padding: 8px;
    cursor: pointer;
    border-radius: 4px;
}
.album-item:hover, .album-item.active {
    background: #b4b4b4;
    color: black
}

/* Pesmi desno */
#tracks {
    flex: 1;
    background: #424242de;
    overflow-y: auto;
    padding: 10px;
}

.track-item {
    padding: 8px;
    cursor: pointer;
    border-radius: 4px;
}
.track-item:hover, .track-item.active {
    background: #cfcfcf;
    color: black
}

/* Spodnja polovica: player */
#player {
    flex: 1;
    padding: 20px;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    background: #2b2b2b;
    box-sizing: border-box;
    align-items: center;
}

#nowPlaying {
    font-size: 24px;
    margin-bottom: 10px;
    text-align: center;
}

#controls {
    margin-top: 20px;
}

button {
    padding: 8px 12px;
    margin-right: 5px;
    font-size: 20px;
    background: #5a5a5a;
    border: none;
    color: white;
    cursor: pointer;
    border-radius: 8px;
}
button:hover {
    background: #555;
}

#seekBar {
    width: 100%;
    margin-top: 10px;
}

#timeDisplay {
    margin-top: 5px;
    font-size: 14px;
    text-align: right;
}

#shuffleBtn.active {
    background: #4caf50;
    color: black;
}

#delete-btn {
    position: fixed;
    bottom: 10px;
    right: 10px;
}

#home {
    background: #396ba5;
}
</style>
</head>
<body>

<div id="browser">
    <div id="albums">
        <h2>Albumi</h2>
        <div id="albumList"></div>
    </div>
    <div id="tracks">
        <h2>Pesmi</h2>
        <div id="trackList"></div>
    </div>
</div>

<div id="player">
    <div id="nowPlaying">Ni izbrane pesmi</div>
    <audio id="audio" preload="auto"></audio>

    <div id="controls">
        <button onclick="prev()">‚èÆ Nazaj</button>
        <button onclick="togglePlay()">‚ñ∂Ô∏è/‚è∏ Play/Pause</button>
        <button onclick="next()">‚è≠ Naprej</button>
        <button id="shuffleBtn" onclick="toggleRandom()">üîÄ Random</button>
        <a href="/"><button id="home">MarinKino</button></a>
    </div>

    <input type="range" id="seekBar" value="0">
    <div id="timeDisplay">0:00 / 0:00</div>
    
    {% if current_user.is_admin %}
    <button id="delete-btn" onclick="izbrisiPesem()" title="Izbri≈°i pesem">
        üóëÔ∏è Izbri≈°i
    </button>
    {% endif %}
</div>

<script>
const albums = {{ albums|tojson }};

const albumListEl = document.getElementById("albumList");
const trackListEl = document.getElementById("trackList");
const audio = document.getElementById("audio");
const nowPlaying = document.getElementById("nowPlaying");
const progress = document.getElementById("seekBar");
const timeDisplay = document.getElementById("timeDisplay");

let currentAlbum = localStorage.getItem("album") || "Vse";
let currentTrack = localStorage.getItem("track") || null;
let currentTime = parseFloat(localStorage.getItem("time") || 0);
let currentSongs = [];
let currentIndex = -1;

// Render albumi
function renderAlbums() {
    albumListEl.innerHTML = "";
    Object.keys(albums).forEach(a => {
        const div = document.createElement("div");
        div.textContent = a;
        div.className = "album-item" + (a===currentAlbum?" active":"");
        div.onclick = () => loadAlbum(a);
        albumListEl.appendChild(div);
    });
}

// Load album
function loadAlbum(name) {
    currentAlbum = name;
    localStorage.setItem("album", name);
    currentSongs = albums[name];
    renderAlbums();

    trackListEl.innerHTML = "";
    currentSongs.forEach((s,i)=>{
        const div = document.createElement("div");
        div.textContent = s.split("/").pop();
        div.className = "track-item" + (s===currentTrack?" active":"");
        div.onclick = ()=>playTrack(i);
        trackListEl.appendChild(div);
    });
    scrollToActiveTrack();
}

// Play track
function playTrack(i) {
    currentIndex = i;
    currentTrack = currentSongs[i];
    localStorage.setItem("track", currentTrack);
    nowPlaying.textContent = currentTrack.split("/").pop();
    audio.src = "/music/" + currentTrack;
    audio.currentTime = 0;
    audio.play().catch(()=>{});
    highlightTrack();
    scrollToActiveTrack();
}

function highlightTrack() {
    document.querySelectorAll(".track-item").forEach((t, idx)=>{
        t.classList.toggle("active", idx===currentIndex);
    });
}

function scrollToActiveTrack() {
    const active = document.querySelector(".track-item.active");
    if(active) active.scrollIntoView({behavior:"smooth", block:"center"});
}

// Controls
function togglePlay() { if(audio.paused) audio.play(); else audio.pause(); }
function next() {
    if(randomMode) playTrack(Math.floor(Math.random()*currentSongs.length));
    else if(currentIndex<currentSongs.length-1) playTrack(currentIndex+1);
}
function prev() { if(currentIndex>0) playTrack(currentIndex-1); }

const shuffleBtn = document.getElementById("shuffleBtn");
let randomMode = JSON.parse(localStorage.getItem("random") || "false");

// Posodobimo gumb ob zagonu
updateShuffleBtn();

// Toggle random
function toggleRandom() {
    randomMode = !randomMode;
    localStorage.setItem("random", randomMode);
    updateShuffleBtn();
}

function updateShuffleBtn() {
    if(randomMode) shuffleBtn.classList.add("active");
    else shuffleBtn.classList.remove("active");
}

// EQ animacija glede na predvajanje
const eqBars = document.querySelectorAll(".eq-bar");

function updateEQ() {
    eqBars.forEach((bar)=>{
        if(!audio.paused && !audio.ended){
            const h = Math.random()*20 + 5; // vi≈°ina 5-25px
            bar.style.height = h+"px";
        } else {
            bar.style.height = "5px"; // mirujoƒçe
        }
    });
}

// Kliƒçemo vsakih 100ms
setInterval(updateEQ, 100);

// Audio update
audio.ontimeupdate = ()=>{
    if(audio.duration){
        progress.value = audio.currentTime;
        localStorage.setItem("time", audio.currentTime);
        timeDisplay.textContent = formatTime(audio.currentTime)+" / "+formatTime(audio.duration);
    }
};
audio.onloadedmetadata = ()=>{
    progress.max = audio.duration;
    if(currentTime && currentTrack===audio.src.replace("/music/","")) audio.currentTime=currentTime;
};
progress.oninput = ()=>{ audio.currentTime = progress.value; }
audio.onended = ()=>next();

function formatTime(s){
    s=Math.floor(s);
    const m=Math.floor(s/60);
    const sec=s%60;
    return m+":"+sec.toString().padStart(2,"0");
}

function izbrisiPesem() {
    const token = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    if (confirm("Res ≈æeli≈° izbrisati to pesem?")) {
        fetch(`/music/delete/` + currentTrack, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': token
            }
        })
        .then(response => {
            if (response.ok) {
                next();
            } else {
                alert("Napaka pri brisanju pesmi!");
            }
        });
    }
}

// Initialize
renderAlbums();
if(currentTrack && currentSongs.length>0) playTrack(currentIndex||0);
else loadAlbum(currentAlbum);
</script>

</body>
</html>
