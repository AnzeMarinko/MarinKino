<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>MarinKino</title>

    <link rel="icon" href="/static/logo.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
</head>

<body class="bg-light text-dark">

<nav class="navbar navbar-expand-lg navbar-light bg-white shadow sticky-top">
  <div class="container-fluid">

    <!-- LOGO + NASLOV -->
    <a class="navbar-brand d-flex align-items-center gap-2" href="/">
      <img src="/static/logo.png" height="36">
      <strong>MarinKino</strong>
    </a>

    <!-- HAMBURGER -->
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar">
      <span class="navbar-toggler-icon"></span>
    </button>

    <!-- MENI -->
    <div class="collapse navbar-collapse" id="mainNavbar">

      <!-- LEVI MENI -->
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="/meme">≈†ale & navdihi</a></li>
        <li class="nav-item"><a class="nav-link" href="/music">Glasba</a></li>
        <li class="nav-item"><a class="nav-link" href="https://anzemarinko.github.io/pod_krinko">Pod krinko</a></li>
      </ul>

      <!-- DESNI DEL: UPORABNIK -->
      <div class="d-flex flex-column flex-lg-row align-items-lg-center gap-2">
        <span class="text-secondary">
          Bog daj <span id="greeting"></span>, <strong>{{ current_user.id }}</strong>
        </span>

        <a href="/logout" class="btn btn-sm btn-outline-info">Odjava</a>

        {% if current_user.is_admin %}
        <a href="/register" class="btn btn-sm btn-outline-warning">+ Uporabnik</a>
        {% endif %}
      </div>

    </div>
  </div>
</nav>

<div class="container my-4">
  <form method="get" class="row g-2 align-items-end bg-white p-3 rounded shadow">

    <div class="col-md-3">
      <select class="form-select" name="movietype">
        <option value="">-- Tip filmov --</option>
        {% for group in group_folders %}
          <option value="{{ group }}" {% if group == selected_movietype %}selected{% endif %}>
            {{ group_folders[group] }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-2">
      <select class="form-select" name="genre">
        <option value="">-- ≈Ωanr --</option>
        {% for genre in known_genres %}
          <option value="{{ genre }}" {% if genre == selected_genre %}selected{% endif %}>
            {{ genre|capitalize }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-3">
      <select class="form-select" name="sort">
        <option value="name-asc">Ime ‚Üë</option>
        <option value="name-desc">Ime ‚Üì</option>
        <option value="runtime-asc">Dol≈æina ‚Üë</option>
        <option value="runtime-desc">Dol≈æina ‚Üì</option>
      </select>
    </div>

    
    <div class="col-md-2 d-flex align-items-end">
        <input type="checkbox"
                class="btn-check"
                id="onlyunwatched"
                name="onlyunwatched"
                {% if onlyunwatched %}checked{% endif %}>

        <label class="btn btn-outline-secondary w-100"
                for="onlyunwatched">
            Skrij pogledano
        </label>
    </div>


    <div class="col-md-2">
        <button class="btn btn-orange w-100">Pripravi</button>
    </div>

  </form>
</div>

 <div class="movie-grid" id="movie-grid"></div>

<footer class="bg-white border-top mt-5">
  <div class="container py-4">

    <div class="row g-4">

      <!-- INFO -->
      <div class="col-md-4">
        <h6 class="fw-bold">üé¨ MarinKino</h6>
        <p class="small text-muted">
          Dru≈æinski pregledovalnik filmov in risank na domaƒçem stre≈æniku.
          Namenjen je enostavni izbiri in ogledu vsebinsko kvalitetnih vsebin.
          Nabor filmov in risank se bo sƒçasoma spreminjal (zaenkrat tudi ne trdim, da je zares vsak film kvaliteten po vsebini).
        </p>
      </div>

      <!-- TEHNIKA -->
      <div class="col-md-4">
        <h6 class="fw-bold">üñ•Ô∏è Tehniƒçne informacije</h6>
        <ul class="small text-muted mb-0">
          <li>Stre≈ænik: Raspberry Pi</li>
          <li>Backend: Python + Flask</li>
          <li>Filmi: piratsko pridobljeni</li>
          <li>Podrobnosti in naslovne slike: avtomatsko pridobljeni in prevedeni z umetno inteligenco</li>
          <li>Podnapisi: ponekod avtomatsko pridobljeni in prevedeni z umetno inteligenco ter avtomatsko poravnani z zvokom, ne pa nujno tudi s sliko</li>
        </ul>
      </div>

      <!-- AVTOR -->
      <div class="col-md-4">
        <h6 class="fw-bold">üë§ O projektu</h6>
        <p class="small text-muted mb-1">
          Avtor in vzdr≈æevanje: <strong>An≈æe Marinko</strong>
        </p>
        <p class="small text-muted">
          Projekt je nastal iz praktiƒçne potrebe in je veƒçinoma avtomatiziran,
          zato so mo≈æne manj≈°e napake v opisih ali prevodih.
          Za novega uporabnika recite skrbniku strani.
        </p>
        <p class="small text-muted">
        <a target="_blank"
     class="footer-link" href="https://github.com/AnzeMarinko/MarinKino">Repozitorij</a>
        </p>
      </div>

    </div>

    <hr class="my-3">

    <div class="d-flex flex-column flex-md-row justify-content-between small text-muted">
      <span>¬© 2025 An≈æe Marinko</span>
      <span>MarinKino</span>
    </div>

  </div>
</footer>

</body>

<script>
    
function odstraniMovieCard(event, form) {
    if (!confirm('Ali res ≈æeli≈° izbrisati vse datoteke v mapi?')) {
        return false;
    }
    event.preventDefault();
    // Najdi najbli≈æji parent z class "movie-card"
    const card = form.closest('.movie-card');
    const token = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    fetch(form.action, { method: 'POST',
        headers: {
            'X-CSRFToken': token
        } })
        .then(resp => resp.json())
        .then(data => console.log('Film odstranjen', data))
        .catch(err => console.error(err));
    if (card) {
        card.remove(); // odstrani iz DOM
    }

    return false; 
}

function getGreeting() {
    const hour = new Date().getHours();

    if (hour < 5)      return "lahko noƒç";
    if (hour < 10)     return "dobro jutro";
    if (hour < 18)     return "dober dan";
    return "dober veƒçer";
}

document.getElementById("greeting").textContent = getGreeting();

let currentPage = 0;
let loading = false;

// CSRF token
const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

// Glavni container
const grid = document.getElementById("movie-grid");

async function loadNextPage() {
    if (loading) return;
    loading = true;

    const response = await fetch(`/movies_page?page=${currentPage}`);
    const data = await response.json();

    data.movies.forEach(movie => {
        const card = renderMovieCard(movie);
        grid.appendChild(card);
    });

    if (data.has_more) {
        currentPage += 1;
        loading = false;
    }
}

// Render funkcija, ki ustvari DOM strukturo enako tvojemu Jinja templatu
function renderMovieCard(movie) {
    const wrapper = document.createElement("div");
    wrapper.className = `movie-card ${movie.movie_id}`;
    wrapper.style = `--watch: ${movie.watch_ratio}%;`;

    wrapper.innerHTML = `
        <a href="/play${movie.folder}">
            <img src="/movies${movie.thumbnail}" alt="Poster" loading="lazy">
        </a>

        <h3>${movie.title}${movie.year}
            <div class="slosinh">${movie.slosinh}</div>
        </h3>

        <div class="genres">
            ${movie.genres.map(g => `
                <span class="genre-badge ${g.toLowerCase().replace(/ /g, '-')}">${g}</span>
            `).join('')}
        </div>

        <div class="description">
            <b>${movie.players}</b><br>
            <hr>${movie.description}<br>
            <hr>${movie.description_2 || ""}

            ${movie.subtitle_buttons?.length ? `
                <br><hr>Podnapisi:
                ${movie.subtitle_buttons.map(s => `<button class="subtitles">${s}</button>`).join("")}
            ` : ""}

            <br><hr>

            <div class="izbira" movie-id="${movie.movie_id}">
                <input type="radio" id="opcija1-${movie.movie_id}" name="izbor-${movie.movie_id}" value="0">
                <label for="opcija1-${movie.movie_id}">Nepogledano</label>

                <input type="radio" id="opcija2-${movie.movie_id}" name="izbor-${movie.movie_id}" value="100">
                <label for="opcija2-${movie.movie_id}">Pogledano</label>
            </div>
        </div>

        <div class="buttons">
            <button class="runtime">${movie.runtimes} min</button>${movie.is_admin ? `
            <form action="/remove${movie.folder}" method="post" onsubmit="return odstraniMovieCard(event, this);">
                <input type="hidden" name="csrf_token" value="${csrfToken}">
                <button type="submit">Odstrani</button>
            </form>
            ` : ""}
        </div>
    `;

    return wrapper;
}

// Infinite scroll trigger
window.addEventListener("scroll", () => {
    if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 100) {
        loadNextPage();
    }
});

// Za≈æeni prvo nalaganje
loadNextPage();

</script>
<script defer src="/static/script.js"></script>
</html>
