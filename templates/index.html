<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>MarinKino</title>
    <link rel="stylesheet" href="/static/css/style.css">
	<link rel="icon" href="/static/logo.png">
</head>
<body>
    <header>
    <h1>MarinKino</h1>
    <div class='logo'>
		<img src="/static/logo.png">
    </div>
    <div class="group-selector">
        <a href="/meme"><button>Zbirka šal in navdihov</button></a>
        <a href="/music"><button>Zbirka glasbe</button></a>
        <a href="https://anzemarinko.github.io/pod_krinko"><button>Družabna igra Pod krinko</button></a>
        <a href="https://github.com/AnzeMarinko/MarinKino/blob/main/README.md"><button>O projektu</button></a>
        
      </div>

    <form method="get">

        <select name="movietype" id="movietype">
            <option value="" {% if group == selected_movietype %}selected{% endif %}>-- Izberi tip filmov --</option>
            {% for group in group_folders %}
                <option value="{{ group }}" {% if group == selected_movietype %}selected{% endif %}>
                    {{ group_folders[group] }}
                </option>
            {% endfor %}
        </select>
        <select name="genre" id="genre">
            <option value="">-- Vsi žanri --</option>
            {% for genre in known_genres %}
                <option value="{{ genre }}" {% if genre == selected_genre %}selected{% endif %}>
                    {{ genre|capitalize }}
                </option>
            {% endfor %}
        </select>
        <select name="sort" id="sort">
            <option value="name-asc" {% if sort == "name-asc" %}selected{% endif %}>Po imenu naraščajoče</option>
            <option value="name-desc" {% if sort == "name-desc" %}selected{% endif %}>Po imenu padajoče</option>
            <option value="runtime-asc" {% if sort == "runtime-asc" %}selected{% endif %}>Po dolžini naraščajoče</option>
            <option value="runtime-desc" {% if sort == "runtime-desc" %}selected{% endif %}>Po dolžini padajoče</option>
        </select>

        <label class="izbira">
            <input type="checkbox" id="onlyunwatched" name="onlyunwatched" {% if onlyunwatched %}checked="checked"{% endif %}>
            <span>Skrij pogledano</span>
        </label>
        <button type="submit">Pripravi</button>
        
    </form>
    <div class="user">
            <p>Bog daj <span id="greeting"></span>, {{ current_user.id }}!</p>
            
            <p><a href="/logout" class="button">Odjava</a></p>

            {% if current_user.is_admin %}
            <p><a href="/register" class="button">Registracija novega uporabnika</a></p>
            {% endif %}
        </div>
    </header>
    <div class='popcorn'>
		<img src="/static/popcorn.png">
    </div>

    <div class="movie-grid" id="movie-grid">
    </div>
	<section>To je pregledovalnik filmov in risank na družinskem disku. 
	Filme in podatke o njih je uredil Anže Marinko v veliki meri avtomatizirano, kar je razlog nekaterih napak in na trenutke slabih prevodov z umetno inteligenco.
    Z uporabo umetne inteligence so prevedeni opisi filmov, podnapisi filmov in z umetno inteligenco so podnapisi tudi poravnani z zvokom (kar ni nujno poravnano tudi s sliko).
Slaba kvaliteta videa lahko izvira iz načina pridobivanja filmov (piratsko).</section>

Stran je dostopna preko domačega Raspberry PI strežnika.
</body>

<script>
    
function odstraniMovieCard(event, form) {
    if (!confirm('Ali res želiš izbrisati vse datoteke v mapi?')) {
        return false;
    }
    event.preventDefault();
    // Najdi najbližji parent z class "movie-card"
    const card = form.closest('.movie-card');
    const token = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    fetch(form.action, { method: 'POST',
        headers: {
            'X-CSRFToken': token
        } })
        .then(resp => resp.json())
        .then(data => console.log('Film odstranjen', data))
        .catch(err => console.error(err));
    if (card) {
        card.remove(); // odstrani iz DOM
    }

    return false; 
}

function getGreeting() {
    const hour = new Date().getHours();

    if (hour < 5)      return "lahko noč";
    if (hour < 10)     return "dobro jutro";
    if (hour < 18)     return "dober dan";
    return "dober večer";
}

document.getElementById("greeting").textContent = getGreeting();

let currentPage = 0;
let loading = false;

// CSRF token
const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

// Glavni container
const grid = document.getElementById("movie-grid");

async function loadNextPage() {
    if (loading) return;
    loading = true;

    const response = await fetch(`/movies_page?page=${currentPage}`);
    const data = await response.json();

    data.movies.forEach(movie => {
        const card = renderMovieCard(movie);
        grid.appendChild(card);
    });

    if (data.has_more) {
        currentPage += 1;
        loading = false;
    }
}

// Render funkcija, ki ustvari DOM strukturo enako tvojemu Jinja templatu
function renderMovieCard(movie) {
    const wrapper = document.createElement("div");
    wrapper.className = `movie-card ${movie.movie_id}`;
    wrapper.style = `--watch: ${movie.watch_ratio}%;`;

    wrapper.innerHTML = `
        <a href="/play${movie.folder}">
            <img src="/movies${movie.thumbnail}" alt="Poster" loading="lazy">
        </a>

        <h3>${movie.title}${movie.year}
            <div class="slosinh">${movie.slosinh}</div>
        </h3>

        <div class="genres">
            ${movie.genres.map(g => `
                <span class="genre-badge ${g.toLowerCase().replace(/ /g, '-')}">${g}</span>
            `).join('')}
        </div>

        <div class="description">
            <b>${movie.players}</b><br>
            <hr>${movie.description}<br>
            <hr>${movie.description_2 || ""}

            ${movie.subtitle_buttons?.length ? `
                <br><hr>Podnapisi:
                ${movie.subtitle_buttons.map(s => `<button class="subtitles">${s}</button>`).join("")}
            ` : ""}

            <br><hr>

            <div class="izbira" movie-id="${movie.movie_id}">
                <input type="radio" id="opcija1-${movie.movie_id}" name="izbor-${movie.movie_id}" value="0">
                <label for="opcija1-${movie.movie_id}">Nepogledano</label>

                <input type="radio" id="opcija2-${movie.movie_id}" name="izbor-${movie.movie_id}" value="100">
                <label for="opcija2-${movie.movie_id}">Pogledano</label>
            </div>
        </div>

        <div class="buttons">
            <button class="runtime">(${movie.runtimes} min)</button>

            ${movie.is_admin ? `
            <form action="/remove${movie.folder}" method="post" onsubmit="return odstraniMovieCard(event, this);">
                <input type="hidden" name="csrf_token" value="${csrfToken}">
                <button type="submit">Odstrani</button>
            </form>
            ` : ""}
        </div>
    `;

    return wrapper;
}

// Infinite scroll trigger
window.addEventListener("scroll", () => {
    if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 100) {
        loadNextPage();
    }
});

// Zaženi prvo nalaganje
loadNextPage();

</script>
<script defer src="/static/script.js"></script>
</html>
