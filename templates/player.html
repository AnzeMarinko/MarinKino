<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ movie.title }}{{ movie.year }}</title>
    <link rel="stylesheet" href="/static/css/style.css">
	<link rel="icon" href="/static/logo.png">
</head>
<body>
    <div class="movie-page">
        <div class="cover"><img src="/movies{{ movie.cover }}" alt="Poster"></div>
        
        <div class="description">
            <h1>{{ movie.title }}{{ movie.year }}<div class="slosinh">{{ movie.slosinh }}</div></h1></br>
            <div class="genres">
                {% for genre in movie.genres %}
                <span class="genre-badge {{ genre|lower|replace(' ', '-') if genre in known_genres else 'unknown' }}">{{ genre }}</span>
                {% endfor %}
            </div></br>
            <hr>
            <b>{{ movie.players }}</b></br>
            <hr>{{ movie.description }}</br>
            <hr>{{ movie.description_2 }}</br>
            <hr>{{ movie.folder }}
        {% if subtitle_buttons %}</br>
            <hr>Podnapisi (izberete v predvajalniku med možnostmi): {% for subtitle in subtitle_buttons %}<button class="subtitles">{{ subtitle }}</button> {% endfor %}
            {% endif %}
        </div>

        <div class="home">
            <a href="/"><img src="/static/logo.png" alt="Home">Domov</a>
        </div>
    </div>

    {% if not is_collection %}
        <video id="videoPlayer" controls playsinline>

            <source src="/movies/{{ group_folder }}/{{ folder }}/{{ video_file }}" type="video/mp4">
            {% if slosubs_file %}
                <track src="/movies/{{ group_folder }}/{{ folder }}/{{ slosubs_file }}" kind="subtitles" srclang="sl" label="{{ slosubs_file|replace('subtitles-', '')|replace('.vtt', '')|replace('Subs', '') }}" default>
            {% endif %}
            
            {% for subtitle in subtitles %}
                {% if subtitle != slosubs_file %}
                <track src="/movies/{{ group_folder }}/{{ folder }}/{{ subtitle }}" kind="subtitles" srclang="{{ subtitle|replace('subtitles-', '')|replace('.vtt', '')|replace('Subs', '') }}" label="{{ subtitle|replace('subtitles-', '')|replace('.vtt', '')|replace('Subs', '') }}">
                {% endif %}
            {% endfor %}
            Tvoj brskalnik ne podpira videa.
        </video>
        <script>
            const video = document.getElementById('videoPlayer');
            const lastTime = {{ movie.last_play_time|default(0) }}; // v sekundah

            video.addEventListener('loadedmetadata', () => {
                if (lastTime < video.duration) {
                    video.currentTime = lastTime;
                }
            });
        </script>
    {% else %}
        {% for video_file in video_files %}
            <button class="video-btn" style="--watch: {{ movie.watch_info[video_file]['watch_ratio']|default(0) }}%;" 
                onclick="playVideo('/movies/{{ group_folder }}/{{ folder }}/{{ video_file }}', {{ movie.watch_info[video_file]['last_play_time']|default(0) }}, this)">
                {{ video_file|replace('.mp4', '') }} ({{ movie.runtimes_by_files[video_file] }} min)
            </button>
        {% endfor %}
        <video id="videoPlayer" width="100%" controls playsinline>
            <source id="videoSource" src="" type="video/mp4">
            Tvoj brskalnik ne podpira videa.
        </video>

        <script>
        function playVideo(src, startTime = 0, button) {
            // Označi izbran gumb
            document.querySelectorAll('.video-btn').forEach(btn => btn.classList.remove('selected'));
            button.classList.add('selected');
            
            // Predvajaj video
            const video = document.getElementById('videoPlayer');
            const source = document.getElementById('videoSource');
            source.src = src;
            video.load();
            video.addEventListener('loadedmetadata', function setStartTime() {
                if (startTime < video.duration) {
                    video.currentTime = startTime;
                }
                video.play();
                video.removeEventListener('loadedmetadata', setStartTime);
            });
        }
        </script>
    {% endif %}

<script>
document.addEventListener("DOMContentLoaded", function () {
    const video = document.getElementById("videoPlayer");
    if (!video) return;

    video.addEventListener("dblclick", () => {
        if (!document.fullscreenElement) {
            // Vklopi celozaslonski način
            if (video.requestFullscreen) {
                video.requestFullscreen();
            } else if (video.webkitRequestFullscreen) { // Safari
                video.webkitRequestFullscreen();
            } else if (video.msRequestFullscreen) { // IE11
                video.msRequestFullscreen();
            }
        } else {
            // Izhod iz celozaslonskega načina
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) { // Safari
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) { // IE11
                document.msExitFullscreen();
            }
        }
    });

    function playVideo(videoPath) {
        const source = document.getElementById("videoSource");

        source.src = videoPath;

        video.load();       // ponastavi video z novimi viri
        video.play();       // začne predvajanje
    }

    // Nastavi interval (v milisekundah)
    const intervalMillis = 20 * 1000;
    const csrfToken = "{{ csrf_token() }}";
    setInterval(() => {
            if (video && !video.paused && !video.ended) {
                fetch("/video-progress", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrfToken
                    },
                    body: JSON.stringify({
                        filename: video.currentSrc,
                        currentTime: video.currentTime,
                        duration: video.duration
                    })
                }).catch(() => {});
                const selectedButton = document.querySelector('.video-btn.selected');
                if (selectedButton) {
                    selectedButton.style.setProperty('--watch', Math.round(video.currentTime / video.duration * 100) + '%');
                }
            }
        }, intervalMillis);
});
</script>

    
</body>
</html>